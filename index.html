<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Soporte Listosoft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Dashboard de Soporte Listosoft</h1>
            <div class="flex items-center space-x-4">
                <select id="yearFilter" class="p-2 border rounded">
                    <!-- Opciones dinámicas de año -->
                </select>
                <select id="categoryFilter" class="p-2 border rounded">
                    <option value="">Todas las categorías</option>
                    <!-- Opciones dinámicas de categoría -->
                </select>
                <select id="assessorFilter" class="p-2 border rounded">
                    <option value="">Todos los asesores</option>
                    <!-- Opciones dinámicas de asesores -->
                </select>
                <button id="loadDataBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Cargar Nuevos Datos
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Tickets por Mes</h2>
                <canvas id="ticketsChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Tiempo de Respuesta Promedio</h2>
                <canvas id="responseTimeChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Casos Atendidos por Asesor</h2>
                <canvas id="casesByAssessorChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Tiempo Promedio por Asesor</h2>
                <canvas id="averageTimeByAssessorChart"></canvas>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-semibold mb-4">Distribución de Tickets por Categoría (Top 10)</h2>
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-semibold mb-4">Empresas que Han Solicitado Asistencia (Top 10)</h2>
            <canvas id="companiesChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-semibold mb-4">Usuarios que Han Solicitado Asistencia (Top 10)</h2>
            <canvas id="usersChart"></canvas>
        </div>
    </div>

    <script>
        let globalData = {};
        let filteredData = {};
        let ticketsChart = null;
        let responseTimeChart = null;
        let categoryChart = null;
        let casesByAssessorChart = null;
        let averageTimeByAssessorChart = null;
        let companiesChart = null;
        let usersChart = null;

        async function loadData() {
            try {
                const response = await fetch('https://juliusfast65.github.io/LSoftSoporteDash/data/tickets_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Datos cargados:', data); // Añade esta línea para verificar los datos en la consola
                globalData = processData(data);
                globalData.tickets = data.tickets; // Asegurarnos de que globalData.tickets esté definido
                populateFilters(globalData);
                applyFilters(); // Aplica los filtros iniciales para el año actual
                updateLastUpdated(data.last_updated);
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                alert('Error al cargar los datos. Usando datos de ejemplo.');
                useExampleData();
            }
        }

        function processData(data) {
            const excludedAssessors = ["1", "53", "27", "15", "35", "38"];
            const ticketsByMonth = {};
            const responseTime = [];
            const categories = new Map();
            const assessors = new Set();
            const companies = new Map();
            const users = new Map();
            const currentYear = new Date().getFullYear();
            const threeMonthsInMilliseconds = 90 * 24 * 60 * 60 * 1000;

            data.tickets.forEach(ticket => {
                const creationDate = new Date(ticket["Fecha de creación"]);
                const closingDate = new Date(ticket["Última actualización"]);
                const duration = closingDate - creationDate;

                if (duration > threeMonthsInMilliseconds || excludedAssessors.includes(ticket["Agente asignado"])) {
                    return;
                }

                const year = creationDate.getFullYear();
                const month = creationDate.getMonth();

                if (!ticketsByMonth[year]) {
                    ticketsByMonth[year] = {};
                }

                if (!ticketsByMonth[year][month]) {
                    ticketsByMonth[year][month] = { month: month, opened: 0, closed: 0 };
                }

                ticketsByMonth[year][month].opened += 1;
                if (ticket["Estado actual"] === "Cerrado" || ticket["Estado actual"] === "Resuelto") {
                    ticketsByMonth[year][month].closed += 1;
                }

                const category = ticket["Temas de ayuda"];
                if (!categories.has(category)) {
                    categories.set(category, 0);
                }
                categories.set(category, categories.get(category) + 1);

                const assessor = ticket["Agente asignado"];
                assessors.add(assessor);

                const company = ticket["Nombre de Empresa propietaria de la Licencia"];
                if (!companies.has(company)) {
                    companies.set(company, 0);
                }
                companies.set(company, companies.get(company) + 1);

                const user = ticket["De"];
                if (!users.has(user)) {
                    users.set(user, 0);
                }
                users.set(user, users.get(user) + 1);

                responseTime.push(duration / 3600000); // Convertir a horas
            });

            return {
                ticketsByMonth: ticketsByMonth,
                responseTime: responseTime,
                categories: Array.from(categories.entries()).sort((a, b) => b[1] - a[1]).slice(0, 10),
                assessors: Array.from(assessors).filter(assessor => !excludedAssessors.includes(assessor)),
                companies: Array.from(companies.entries()).sort((a, b) => b[1] - a[1]).slice(0, 10),
                users: Array.from(users.entries()).sort((a, b) => b[1] - a[1]).slice(0, 10)
            };
        }

        function populateFilters(data) {
            const yearFilter = document.getElementById('yearFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const assessorFilter = document.getElementById('assessorFilter');

            // Limpiar las opciones anteriores
            yearFilter.innerHTML = '';
            categoryFilter.innerHTML = '<option value="">Todas las categorías</option>';
            assessorFilter.innerHTML = '<option value="">Todos los asesores</option>';

            const years = Object.keys(data.ticketsByMonth).sort((a, b) => b - a);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });

            data.categories.forEach(([category]) => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });

            data.assessors.forEach(assessor => {
                const option = document.createElement('option');
                option.value = assessor;
                option.textContent = assessor;
                assessorFilter.appendChild(option);
            });

            // Seleccionar el año actual por defecto
            yearFilter.value = new Date().getFullYear();
        }

        function updateLastUpdated(timestamp) {
            const lastUpdatedElement = document.getElementById('lastUpdated');
            if (lastUpdatedElement) {
                const date = new Date(timestamp);
                lastUpdatedElement.textContent = `Última actualización: ${date.toLocaleString()}`;
            }
        }

        function useExampleData() {
            globalData = {
                lastUpdated: new Date().toISOString(),
                ticketsByMonth: {
                    '2024': {
                        0: { month: 0, opened: 12, closed: 10 },
                        1: { month: 1, opened: 19, closed: 15 },
                        2: { month: 2, opened: 3, closed: 5 },
                        3: { month: 3, opened: 5, closed: 4 },
                        4: { month: 4, opened: 2, closed: 3 },
                        5: { month: 5, opened: 3, closed: 2 }
                    }
                },
                responseTime: [1, 2, 3, 2, 1, 2],
                categories: [['Hardware', 5], ['Software', 3], ['Red', 2]],
                assessors: ['Asesor 1', 'Asesor 2'],
                companies: [['Empresa A', 5], ['Empresa B', 3]],
                users: [['Usuario 1', 4], ['Usuario 2', 3]],
                tickets: [] // Ejemplo de datos de tickets
            };
            populateFilters(globalData);
            applyFilters();
            updateLastUpdated(globalData.lastUpdated);
        }

        function applyFilters() {
            const yearFilter = document.getElementById('yearFilter').value || new Date().getFullYear();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const assessorFilter = document.getElementById('assessorFilter').value;

            filteredData.ticketsByMonth = globalData.ticketsByMonth[yearFilter];
            filteredData.responseTime = globalData.responseTime;
            filteredData.categories = globalData.categories;
            filteredData.companies = globalData.companies;
            filteredData.users = globalData.users;

            if (categoryFilter || assessorFilter) {
                filteredData.ticketsByMonth = Object.fromEntries(Object.entries(filteredData.ticketsByMonth).map(([month, data]) => {
                    const ticketsFiltered = globalData.tickets.filter(ticket => {
                        const ticketYear = new Date(ticket["Fecha de creación"]).getFullYear();
                        const ticketMonth = new Date(ticket["Fecha de creación"]).getMonth();
                        const matchesYear = ticketYear == yearFilter;
                        const matchesMonth = ticketMonth == month;
                        const matchesCategory = categoryFilter ? ticket["Temas de ayuda"] == categoryFilter : true;
                        const matchesAssessor = assessorFilter ? ticket["Agente asignado"] == assessorFilter : true;
                        return matchesYear && matchesMonth && matchesCategory && matchesAssessor;
                    });

                    return [month, {
                        ...data,
                        opened: ticketsFiltered.length,
                        closed: ticketsFiltered.filter(ticket => ticket["Estado actual"] === "Cerrado" || ticket["Estado actual"] === "Resuelto").length
                    }];
                }));
            }

            updateCharts();
        }

        function updateCharts() {
            updateTicketsChart();
            updateResponseTimeChart();
            updateCategoryChart();
            updateCasesByAssessorChart();
            updateAverageTimeByAssessorChart();
            updateCompaniesChart();
            updateUsersChart();
        }

        function updateTicketsChart() {
            if (!filteredData.ticketsByMonth || !Array.isArray(Object.values(filteredData.ticketsByMonth))) {
                console.error('La estructura de datos de ticketsByMonth es incorrecta:', filteredData.ticketsByMonth);
                return;
            }

            // Destruir la instancia anterior del gráfico si existe
            if (ticketsChart) {
                ticketsChart.destroy();
            }

            const ctx = document.getElementById('ticketsChart').getContext('2d');
            ticketsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(filteredData.ticketsByMonth).map(d => new Date(0, d.month).toLocaleString('es-ES', { month: 'long' })),
                    datasets: [{
                        label: 'Tickets Abiertos',
                        data: Object.values(filteredData.ticketsByMonth).map(d => d.opened),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Tickets Cerrados',
                        data: Object.values(filteredData.ticketsByMonth).map(d => d.closed),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateResponseTimeChart() {
            if (responseTimeChart) {
                responseTimeChart.destroy();
            }

            const ctx = document.getElementById('responseTimeChart').getContext('2d');
            responseTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.values(filteredData.ticketsByMonth).map(d => new Date(0, d.month).toLocaleString('es-ES', { month: 'long' })),
                    datasets: [{
                        label: 'Tiempo de Respuesta Promedio (horas)',
                        data: filteredData.responseTime,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCategoryChart() {
            if (categoryChart) {
                categoryChart.destroy();
            }

            const ctx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filteredData.categories.map(([category]) => category),
                    datasets: [{
                        label: 'Tickets',
                        data: filteredData.categories.map(([_, count]) => count),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Tickets por Categoría (Top 10)'
                        }
                    }
                }
            });
        }

        function updateCasesByAssessorChart() {
            if (casesByAssessorChart) {
                casesByAssessorChart.destroy();
            }

            const assessorData = globalData.assessors.map(assessor => {
                return globalData.tickets.filter(ticket => ticket["Agente asignado"] === assessor).length;
            });

            const ctx = document.getElementById('casesByAssessorChart').getContext('2d');
            casesByAssessorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: globalData.assessors,
                    datasets: [{
                        label: 'Casos Atendidos',
                        data: assessorData,
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateAverageTimeByAssessorChart() {
            if (averageTimeByAssessorChart) {
                averageTimeByAssessorChart.destroy();
            }

            const assessorData = globalData.assessors.map(assessor => {
                const tickets = globalData.tickets.filter(ticket => ticket["Agente asignado"] === assessor);
                const totalResponseTime = tickets.reduce((sum, ticket) => {
                    const creationTime = new Date(ticket["Fecha de creación"]);
                    const closingTime = new Date(ticket["Última actualización"]);
                    return sum + (closingTime - creationTime) / 3600000; // Convertir a horas
                }, 0);
                return totalResponseTime / tickets.length;
            });

            const ctx = document.getElementById('averageTimeByAssessorChart').getContext('2d');
            averageTimeByAssessorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: globalData.assessors,
                    datasets: [{
                        label: 'Tiempo Promedio de Atención (horas)',
                        data: assessorData,
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCompaniesChart() {
            if (companiesChart) {
                companiesChart.destroy();
            }

            const ctx = document.getElementById('companiesChart').getContext('2d');
            companiesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filteredData.companies.map(([company]) => company),
                    datasets: [{
                        label: 'Tickets',
                        data: filteredData.companies.map(([_, count]) => count),
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Empresas que Han Solicitado Asistencia (Top 10)'
                        }
                    }
                }
            });
        }

        function updateUsersChart() {
            if (usersChart) {
                usersChart.destroy();
            }

            const ctx = document.getElementById('usersChart').getContext('2d');
            usersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filteredData.users.map(([user]) => user),
                    datasets: [{
                        label: 'Tickets',
                        data: filteredData.users.map(([_, count]) => count),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Usuarios que Han Solicitado Asistencia (Top 10)'
                        }
                    }
                }
            });
        }

        document.getElementById('loadDataBtn').addEventListener('click', loadData);
        document.getElementById('yearFilter').addEventListener('change', applyFilters);
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('assessorFilter').addEventListener('change', applyFilters);

        // Carga inicial de datos
        loadData();
    </script>
</body>
</html>

                            
