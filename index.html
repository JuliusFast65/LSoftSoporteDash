<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Soporte Listosoft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Dashboard de Soporte Listosoft</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Tickets por Mes</h2>
                <canvas id="ticketsChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Tiempo de Respuesta Promedio</h2>
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-semibold mb-4">Distribución de Tickets por Categoría</h2>
            <canvas id="categoryChart"></canvas>
        </div>
        
        <div class="flex justify-center mb-8">
            <button id="loadDataBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Cargar Nuevos Datos
            </button>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Filtros</h2>
            <div class="flex flex-wrap gap-4">
                <select id="yearFilter" class="p-2 border rounded">
                    <!-- Opciones dinámicas de año -->
                </select>
                <select id="categoryFilter" class="p-2 border rounded">
                    <option value="">Todas las categorías</option>
                    <!-- Opciones dinámicas de categoría -->
                </select>
            </div>
        </div>
    </div>

    <script>
        let globalData = {};
        let filteredData = {};
        let ticketsChart = null;
        let responseTimeChart = null;
        let categoryChart = null;

        async function loadData() {
            try {
                const response = await fetch('data/tickets_data.json'); // Cambia a la URL correcta
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Datos cargados:', data); // Añade esta línea para verificar los datos en la consola
                globalData = processData(data);
                globalData.tickets = data.tickets; // Asegurarnos de que globalData.tickets esté definido
                populateFilters(globalData);
                applyFilters(); // Aplica los filtros iniciales para el año actual
                updateLastUpdated(data.last_updated);
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                alert('Error al cargar los datos. Usando datos de ejemplo.');
                useExampleData();
            }
        }

        function processData(data) {
            const ticketsByMonth = {};
            const responseTime = [];
            const categories = new Set();
            const currentYear = new Date().getFullYear();

            data.tickets.forEach(ticket => {
                const creationDate = new Date(ticket["Fecha de creación"]);
                const year = creationDate.getFullYear();
                const month = creationDate.getMonth();

                if (!ticketsByMonth[year]) {
                    ticketsByMonth[year] = {};
                }

                if (!ticketsByMonth[year][month]) {
                    ticketsByMonth[year][month] = { month: month, opened: 0, closed: 0 };
                }

                ticketsByMonth[year][month].opened += 1;
                if (ticket["Estado actual"] === "Cerrado" || ticket["Estado actual"] === "Resuelto") {
                    ticketsByMonth[year][month].closed += 1;
                }

                const category = ticket["Temas de ayuda"];
                categories.add(category);
            });

            return {
                ticketsByMonth: ticketsByMonth,
                responseTime: calculateResponseTime(data.tickets),
                categories: Array.from(categories)
            };
        }

        function calculateResponseTime(tickets) {
            const responseTimes = [];
            tickets.forEach(ticket => {
                const creationTime = new Date(ticket["Fecha de creación"]);
                const closingTime = new Date(ticket["Última actualización"]);
                const responseTime = (closingTime - creationTime) / 3600000; // Convertir a horas
                responseTimes.push(responseTime);
            });
            return responseTimes;
        }

        function populateFilters(data) {
            const yearFilter = document.getElementById('yearFilter');
            const categoryFilter = document.getElementById('categoryFilter');

            // Limpiar las opciones anteriores
            yearFilter.innerHTML = '';
            categoryFilter.innerHTML = '<option value="">Todas las categorías</option>';

            const years = Object.keys(data.ticketsByMonth).sort((a, b) => b - a);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });

            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });

            // Seleccionar el año actual por defecto
            yearFilter.value = new Date().getFullYear();
        }

        function updateLastUpdated(timestamp) {
            const lastUpdatedElement = document.getElementById('lastUpdated');
            if (lastUpdatedElement) {
                const date = new Date(timestamp);
                lastUpdatedElement.textContent = `Última actualización: ${date.toLocaleString()}`;
            }
        }

        function useExampleData() {
            globalData = {
                lastUpdated: new Date().toISOString(),
                ticketsByMonth: {
                    '2024': {
                        0: { month: 0, opened: 12, closed: 10 },
                        1: { month: 1, opened: 19, closed: 15 },
                        2: { month: 2, opened: 3, closed: 5 },
                        3: { month: 3, opened: 5, closed: 4 },
                        4: { month: 4, opened: 2, closed: 3 },
                        5: { month: 5, opened: 3, closed: 2 }
                    }
                },
                responseTime: [1, 2, 3, 2, 1, 2],
                categories: ['Hardware', 'Software', 'Red', 'Otro'],
                tickets: [] // Ejemplo de datos de tickets
            };
            populateFilters(globalData);
            applyFilters();
            updateLastUpdated(globalData.lastUpdated);
        }

        function applyFilters() {
            const yearFilter = document.getElementById('yearFilter').value || new Date().getFullYear();
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredData.ticketsByMonth = globalData.ticketsByMonth[yearFilter];
            filteredData.responseTime = globalData.responseTime;
            filteredData.categories = globalData.categories;

            if (categoryFilter) {
                filteredData.ticketsByMonth = Object.fromEntries(Object.entries(filteredData.ticketsByMonth).map(([month, data]) => {
                    return [month, {
                        ...data,
                        opened: globalData.tickets.filter(ticket => new Date(ticket["Fecha de creación"]).getFullYear() == yearFilter && new Date(ticket["Fecha de creación"]).getMonth() == month && ticket["Temas de ayuda"] == categoryFilter).length,
                        closed: globalData.tickets.filter(ticket => new Date(ticket["Fecha de creación"]).getFullYear() == yearFilter && new Date(ticket["Fecha de creación"]).getMonth() == month && ticket["Temas de ayuda"] == categoryFilter && (ticket["Estado actual"] === "Cerrado" || ticket["Estado actual"] === "Resuelto")).length
                    }];
                }));
            }

            updateCharts();
        }

        function updateCharts() {
            updateTicketsChart();
            updateResponseTimeChart();
            updateCategoryChart();
        }

        function updateTicketsChart() {
            if (!filteredData.ticketsByMonth || !Array.isArray(Object.values(filteredData.ticketsByMonth))) {
                console.error('La estructura de datos de ticketsByMonth es incorrecta:', filteredData.ticketsByMonth);
                return;
            }

            // Destruir la instancia anterior del gráfico si existe
            if (ticketsChart) {
                ticketsChart.destroy();
            }

            const ctx = document.getElementById('ticketsChart').getContext('2d');
            ticketsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(filteredData.ticketsByMonth).map(d => new Date(0, d.month).toLocaleString('es-ES', { month: 'long' })),
                    datasets: [{
                        label: 'Tickets Abiertos',
                        data: Object.values(filteredData.ticketsByMonth).map(d => d.opened),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Tickets Cerrados',
                        data: Object.values(filteredData.ticketsByMonth).map(d => d.closed),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateResponseTimeChart() {
            if (responseTimeChart) {
                responseTimeChart.destroy();
            }

            const ctx = document.getElementById('responseTimeChart').getContext('2d');
            responseTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.values(filteredData.ticketsByMonth).map(d => new Date(0, d.month).toLocaleString('es-ES', { month: 'long' })),
                    datasets: [{
                        label: 'Tiempo de Respuesta Promedio (horas)',
                        data: filteredData.responseTime,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCategoryChart() {
            if (categoryChart) {
                categoryChart.destroy();
            }

            const ctx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: filteredData.categories,
                    datasets: [{
                        data: filteredData.categories.map(category => {
                            return globalData.tickets.filter(ticket => ticket["Temas de ayuda"] === category).length;
                        }),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Tickets por Categoría'
                        }
                    }
                }
            });
        }

        document.getElementById('loadDataBtn').addEventListener('click', loadData);
        document.getElementById('yearFilter').addEventListener('change', applyFilters);
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);

        // Carga inicial de datos
        loadData();
    </script>
</body>
</html>
